#!/bin/tcsh -xef

#created June 8, 2018 (Catherine Cunningham)
#performs pre-preprocessing of DWI and associated structural images using FATCAT commands
#prepares data for TORTOISE preprocessing steps
########### Input Variables ##################
set home_dir 

###################################

set Sublist = (S01)

foreach subj ($Sublist)
	mkdir /Volumes/shares/BNU/cnsraid/schintu/data_analysis/Exp2_DTI/Subjects_proc/{$subj}
	# set paths for subject raw data and output data folders 
	set path_S_ss = /Volumes/shares/BNU/cnsraid/schintu/data_analysis/Exp2_DTI/Subjects/{$subj}
set path_P_ss = /Volumes/shares/BNU/cnsraid/schintu/data_analysis/Exp2_DTI/Subjects_proc/{$subj}


###################################

# convert DWIs from raw DICOMs to usable formats
# for data acquired in two phase-encoded directions, this step is performed twice

echo
echo //////{$subj} convert DWIs////// 
echo

fat_proc_convert_dcm_dwis              \
    -indir  $path_S_ss/DTI_AP/mr_*  \
    -prefix $path_P_ss/dwi_00/ap

fat_proc_convert_dcm_dwis              \
    -indir  $path_S_ss/DTI_PA/mr_*  \
    -prefix $path_P_ss/dwi_00/pa

###################################

# convert anatomical from raw DICOMs to usable formats
# performed for both t1-weighted and t2-weighted anatomical volumes

echo
echo //////{$subj} convert anatomical////// 
echo

fat_proc_convert_dcm_anat              \
    -indir  $path_S_ss/t1w/mr_*     \
    -prefix $path_P_ss/anat_00/t1w

fat_proc_convert_dcm_anat              \
    -indir  $path_S_ss/t2w/mr_0*     \
    -prefix $path_P_ss/anat_00/t2w

###################################

# axialize T2 using reference volumes and resample to 1mm isotropic 

echo
echo //////{$subj} axialize//////
echo

# paths to axialized reference volumes
set here       = $PWD
set ref_t2w    = $here/fatcat_proc_mni_ref/mni_icbm152_t2_relx_tal_nlin_sym_09a_ACPCE.nii.gz
set ref_t2w_wt = $here/fatcat_proc_mni_ref/mni_icbm152_t2_relx_tal_nlin_sym_09a_ACPCE_wtell.nii.gz

fat_proc_axialize_anat                       \
    -inset  $path_P_ss/anat_00/t2w.nii.gz    \
    -prefix $path_P_ss/anat_01/t2w           \
    -mode_t2w                                \
    -refset          $ref_t2w                \
    -extra_al_wtmask $ref_t2w_wt             \
    -extra_al_opts "-newgrid 1.0".           \
    -out_match_ref

###################################

# align T1w -> T2w - to bring T1 into already axialized T2 space

echo
echo //////{$subj} align////// 
echo

fat_proc_align_anat_pair                     \
    -in_t1w    $path_P_ss/anat_00/t1w.nii.gz \
    -in_t2w    $path_P_ss/anat_01/t2w.nii.gz \
    -prefix    $path_P_ss/anat_01/t1w        \
    -out_t2w_grid			     \
    -do_ss_tmp_t1w

end #subj 
